**[⬅ ย้อนกลับ](https://got2546.github.io/)**

# --- ___การจัดการช่องโหว่ Local File Inclusion (LFI)___ ---
## เป้าหมาย: ไฟล์ rlfi.php ในระบบ bWAPP ระดับความยาก: ปานกลาง (Medium)
![This is an alt text.](/img/img2/63.png)

=== 

# โปรแกรมที่ใช้และวิธีดาวน์โหลดและติดตั้ง
# [Download VirtualBox](/VirtualBox.md)<br>
# [WinSCP 6.5 Download](/WinSCP.md)

=== 

# ทฤษฎีและกลไก (The Concept)
## ก่อนจะเจาะ เราต้องเข้าใจก่อนว่า "มันพังเพราะอะไร"


## Local File Inclusion (LFI) คืออะไร?
### LFI คือช่องโหว่ที่เกิดขึ้นเมื่อเว็บไซต์ "ยอมรับชื่อไฟล์จากผู้ใช้" แล้วนำไปเปิดใช้งานโดยไม่ตรวจสอบ แฮกเกอร์จึงฉวยโอกาสเปลี่ยนชื่อไฟล์เป็นไฟล์ความลับของระบบ (เช่น ไฟล์รหัสผ่าน) เพื่อให้หน้าเว็บแสดงผลออกมา

## กลไกการทำงานของ PHP
### ในภาษา PHP คำสั่ง include() มีหน้าที่ "ดูด" โค้ดจากไฟล์อื่นมารันในหน้านี้
+ ปกติ: เราส่ง lang_en.php -> ระบบไปดูดไฟล์ภาษาอังกฤษมาแสดง
+ โจมตี: เราส่ง /etc/passwd -> ระบบไปดูดไฟล์รหัสผ่านของ Linux มาแสดง (เพราะมันซื่อบื้อ ทำตามคำสั่งทุกอย่าง)

---

# ขั้นตอนการค้นหา (Discovery Phase)
## เราเริ่มต้นด้วยการใช้เครื่องมือตรวจสอบโค้ด (Static Application Security Testing - SAST)
![This is an alt text.](/img/img2/63.png)


## การสแกนด้วย RIPS
+ เป้าหมาย: สแกนโฟลเดอร์ /var/www/html/bWAPP/
+ การตั้งค่า: เลือกไฟล์ rlfi.php หรือค้นหา keyword ว่า xss หรือ file inclusion

## วิเคราะห์ผลลัพธ์ (Code Analysis)
### จากรูปที่คุณส่งมา RIPS แจ้งเตือนสีเหลืองที่บรรทัด 94
```php
94: include($language);
```
### RIPS กำลังบอกเราว่า
1. Source (จุดรับเชื้อ): ตัวแปร $language รับค่ามาจาก $_GET["language"] (สิ่งที่ผู้ใช้พิมพ์ใน URL)
2. Flow (การไหล): ไม่มีการกรองคำสั่ง (No sanitization) เชื้อโรคไหลผ่านฉลุย
3. Sink (จุดระเบิด): ตัวแปรนั้นไหลลงไปในฟังก์ชัน include() โดยตรง

---

# ขั้นตอนการเจาะระบบ (Exploitation Phase)
## เมื่อรู้ว่าโค้ดมีช่องโหว่ เราต้องพิสูจน์ด้วยการขโมยไฟล์ /etc/passwd (ไฟล์เก็บรายชื่อ User ใน Linux)
![This is an alt text.](/img/img2/66.png)


## เทคนิค Directory Traversal (../)
### ปกติไฟล์ rlfi.php อยู่ลึกมากที่ /var/www/html/bWAPP/rlfi.php ถ้าเราสั่งให้เปิด /etc/passwd เฉยๆ มันจะหาไม่เจอ เพราะมันจะไปหาที่ /var/www/html/bWAPP/etc/passwd

## เราจึงต้องใช้รหัสลับ ../ (จุดจุดทับ) ซึ่งแปลว่า "ถอยหลังกลับไป 1 โฟลเดอร์"

## การสร้าง Payload (สูตรโกง)
เราต้องถอยหลังไปให้ถึงราก (Root Directory)
1. อยู่ที่ bWAPP -> ใช้ ../ ถอยไป html
2. อยู่ที่ html -> ใช้ ../ ถอยไป www
3. อยู่ที่ www -> ใช้ ../ ถอยไป var
4. อยู่ที่ var -> ใช้ ../ ถอยไป / (Root)
## Payload ที่สมบูรณ์: ../../../../etc/passwd

## การโจมตีจริง (Execution)
+ URL: .../rlfi.php?language=../../../../etc/passwd&action=go
+ สิ่งที่ Server ทำ: มันจะวิ่งย้อน directory ตามที่เราสั่ง แล้วไปหยิบไฟล์ passwd มาแปะบนหน้าเว็บ
+ หลักฐาน: หน้าจอแสดงข้อความ root:x:0:0... ไหลออกมาเต็มหน้าจอ

---

# ขั้นตอนการปิดช่องโหว่ (Remediation Phase)
### การแก้ที่ยั่งยืนไม่ใช่การ "ห้ามคำว่า ../" (Blacklist) เพราะแฮกเกอร์มีวิธีหลบเลี่ยง วิธีที่ดีที่สุดคือ "Whitelist" (อนุญาตเฉพาะคนที่รู้จัก)


## หลักการเขียนโค้ดใหม่ (Secure Coding)
### เราจะโละโค้ดเก่าทิ้ง แล้วใช้โครงสร้าง switch...case แทน
+ Logic: "ถ้าลูกค้าขอไฟล์ A, B หรือ C ให้หยิบให้... แต่ถ้าขอไฟล์อื่นนอกจากนี้ ให้ถีบออกไปทันที"

## โค้ดที่ยังไม่ได้แก้ 
![This is an alt text.](/img/img2/64.jpg)

## โค้ดที่แก้ไขแล้ว 
![This is an alt text.](/img/img2/65.jpg)

## ทำไมถึงปลอดภัย?
### RIPS หรือ Hacker จะไม่สามารถแทรกแซงคำสั่ง include ได้อีกต่อไป เพราะชื่อไฟล์ถูกฝังตายตัวไว้ในโค้ด (Hardcoded) ต่อให้ส่งค่าแปลกๆ มา ก็จะไปตกที่ default case เสมอ

---

# การตรวจสอบความสมบูรณ์ (Verification Phase)
## หลังแก้โค้ด เราต้องตรวจเช็ค 3 มิติ เพื่อยืนยันว่างานเสร็จสมบูรณ์


## ตรวจสอบความปลอดภัย (Security Check)
+ การทดสอบ: ยิง Payload เดิม ../../../../etc/passwd
+ ผลลัพธ์: หน้าเว็บขึ้นข้อความสีแดง "Access Denied" แทนที่จะโชว์ไฟล์ความลับ
+ สถานะ: ✅ ผ่าน (กันแฮกเกอร์ได้แล้ว)
![This is an alt text.](/img/img2/68.png)

## ตรวจสอบกับ RIPS (Static Analysis Check)
+ การทดสอบ: สแกนไฟล์ rlfi.php ซ้ำ
+ ผลลัพธ์: RIPS ไม่แสดงแถบสีแดงหรือเหลืองอีกต่อไป ขึ้นสถานะ No vulnerabilities found
+ เหตุผล: RIPS วิเคราะห์แล้วว่า User Input ไม่สามารถเดินทางไปถึงฟังก์ชันอันตรายได้
+ สถานะ: ✅ ผ่าน (โค้ดสะอาดตามมาตรฐาน)
![This is an alt text.](/img/img2/67.png)

## ตรวจสอบการใช้งาน (Usability Check)
+ การทดสอบ: เลือกภาษา "English" จากเมนูหน้าเว็บ
+ ผลลัพธ์: เว็บไซต์โหลดข้อความภาษาอังกฤษได้ปกติ ไม่พัง ไม่ Error
+ สถานะ: ✅ ผ่าน (ผู้ใช้ใช้งานได้ปกติ)
![This is an alt text.](/img/img2/67.png)

---

## ทำไมถึงปลอดภัย?
### RIPS หรือ Hacker จะไม่สามารถแทรกแซงคำสั่ง include ได้อีกต่อไป เพราะชื่อไฟล์ถูกฝังตายตัวไว้ในโค้ด (Hardcoded) ต่อให้ส่งค่าแปลกๆ มา ก็จะไปตกที่ default case เสมอ



